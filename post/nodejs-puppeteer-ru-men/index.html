<!DOCTYPE html>
<html>
  <head>
      
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>å´å…ˆç”Ÿã€‚</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="æ¸©æ•…è€ŒçŸ¥æ–°"/>
<meta name="keywords" content="æ¸©æ•…è€ŒçŸ¥æ–°"/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://ershaoyelxw.github.io/gridea.github.io/favicon.ico">

<link rel="stylesheet" href="https://ershaoyelxw.github.io/gridea.github.io/styles/main.css">

<!-- Modernizr JS -->
<script src="https://ershaoyelxw.github.io/gridea.github.io/media/scripts/_vendors/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://ershaoyelxw.github.io/gridea.github.io/media/scripts/_vendors/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->

    
        <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
    

    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/tomorrow-night.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<link crossorigin="anonymous" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" href="https://lib.baomitu.com/font-awesome/5.8.1/css/all.min.css" rel="stylesheet">

  </head>
  <body>
  
<div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://ershaoyelxw.github.io/gridea.github.io/media/images/avatar.png" alt="å´å…ˆç”Ÿã€‚" class="img-responsive">
        </figure>
        <h3 class="heading">ABOUT ME</h3>
        <h2>å´å…ˆç”Ÿã€‚</h2>
        <p>æ¸©æ•…è€ŒçŸ¥æ–°</p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">
        <div class="fh5co-box">
            <h3 class="heading">æœç´¢</h3>
            <form action="#">
                <div class="form-group">
                    <input type="text" class="form-control" placeholder="è¾“å…¥å…³é”®å­—">
                </div>
            </form>
        </div>
        <div class="fh5co-box">
            <h3 class="heading">æ ‡ç­¾</h3>
            <ul>
                
                    <li><a href="https://ershaoyelxw.github.io/gridea.github.io/tag/NSTs1AWaV">å¾®ä¿¡å°ç¨‹åº</a></li>
                
                    <li><a href="https://ershaoyelxw.github.io/gridea.github.io/tag/FUgPJNxv_">docker</a></li>
                
                    <li><a href="https://ershaoyelxw.github.io/gridea.github.io/tag/qoqgOifuy">Javascript</a></li>
                
                    <li><a href="https://ershaoyelxw.github.io/gridea.github.io/tag/kt6LnviFL">react-native</a></li>
                
                    <li><a href="https://ershaoyelxw.github.io/gridea.github.io/tag/Fw5HMNT7U">css</a></li>
                
                    <li><a href="https://ershaoyelxw.github.io/gridea.github.io/tag/9Ql766n5d">linux</a></li>
                
                    <li><a href="https://ershaoyelxw.github.io/gridea.github.io/tag/3Bw8-uM5a">html</a></li>
                
                    <li><a href="https://ershaoyelxw.github.io/gridea.github.io/tag/KKDdLMvqX">apicloud</a></li>
                
                    <li><a href="https://ershaoyelxw.github.io/gridea.github.io/tag/gridea">Gridea</a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="https://ershaoyelxw.github.io/gridea.github.io"
                         >
                            é¦–é¡µ
                        </a>
                    </li>
                
                    <li>
                        <a href="https://ershaoyelxw.github.io/gridea.github.io/archives"
                         >
                            å½’æ¡£
                        </a>
                    </li>
                
                    <li>
                        <a href="https://ershaoyelxw.github.io/gridea.github.io/tags"
                         >
                            æ ‡ç­¾
                        </a>
                    </li>
                
                    <li>
                        <a href="https://ershaoyelxw.github.io/gridea.github.io/post/about/"
                         >
                            å…³äº
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://ershaoyelxw.github.io/gridea.github.io">å´å…ˆç”Ÿã€‚</a>
                </h1>
            </div>
        </div>
    </div>
</header>


<!--  <a href="#" class="fh5co-post-prev"><span>ğŸ‘ˆ Prev</span></a>-->
<!--  <a href="#" class="fh5co-post-next"><span>Next ğŸ‘‰</span></a>-->

  <div class="container-fluid">
      <div class="row fh5co-post-entry single-entry">
          <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
              <figure class="animate-box">
                  
              </figure>
              <span class="fh5co-meta animate-box">
                  
                      <div class="tag-container">
                          
                              <a href="https://ershaoyelxw.github.io/gridea.github.io/tag/Ct8K7LqmT" class="tag">nodejs, </a>
                          
                      </div>
                  
              </span>
              <h2 class="fh5co-article-title animate-box">Nodejs puppeteerå…¥é—¨</h2>
              <span class="fh5co-meta fh5co-date animate-box">2019-05-15</span>

              <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                  <div class="row">
                      <div class="col-md-12 animate-box post-content">
                          <p> <p>è½¬è½½ï¼š https://aaron-bird.github.io/2019/04/22/puppeteer%E5%85%A5%E9%97%A8/</p>
<h3 id="å®‰è£…">å®‰è£…</h3>
<p>å®‰è£…puppeteeræ—¶ä¼šè‡ªåŠ¨ä¸‹è½½chrome</p>
<pre><code>yarn add puppeteer
æˆ–
npm i puppeteer
</code></pre>
<p>æ–°å»ºindex.jsåï¼Œåœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹ï¼Œæ‰§è¡Œ node index.js å‘½ä»¤</p>
<pre><code>const puppeteer = require('puppeteer');

// æ‰“å¼€æµè§ˆå™¨
// launchæ–¹æ³•è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡
puppeteer.launch({headless: false}).then(async browser =&gt; {
  // æ‰“å¼€ä¸€ä¸ªé¡µé¢
  const page = await browser.newPage();
  // æ‰“å¼€ç™¾åº¦
  await page.goto('https://www.baidu.com');
  await page.screenshot({path: 'baidu.png'});
  // å…³é—­æµè§ˆå™¨
  // await browser.close();
});
</code></pre>
<h4 id="å¸¸ç”¨å‚æ•°">å¸¸ç”¨å‚æ•°:</h4>
<p>headless æ˜¯å¦å¯ç”¨&quot;æ— å¤´æ¨¡å¼&quot;(éšè—æµè§ˆå™¨ç•Œé¢), é»˜è®¤ä¸ºtrue
devtools æ˜¯å¦è‡ªåŠ¨æ‰“å¼€DevToolså·¥å…·</p>
<pre><code>const puppeteer = require('puppeteer');  
(async () =&gt; {
  const browser = await puppeteer.launch({
    headless: false,
    executablePath: 'C:/chromium/chrome.exe',
    args: [
      '--disable-web-security', // å…è®¸è·¨åŸŸ
      '--proxy-server=127.0.0.1:1080', // ä»£ç†
    ]
  });
})();
</code></pre>
<pre><code>const puppeteer = require('puppeteer');
(async () =&gt; {
  const browser = await puppeteer.launch({headless: true}); //å¯åŠ¨æµè§ˆå™¨
  // å¯åŠ¨æ— ç—•æ¨¡å¼
  const context = await browser.createIncognitoBrowserContext();
  // æ–°å»ºæ ‡ç­¾é¡µ
  const page = await context.newPage();
  // æ‰“å¼€ç›®æ ‡url
  await page.goto('https://baidu.com');
  // å…³é—­æ— ç—•æ¨¡å¼
  await context.close();
  // å…³é—­æµè§ˆå™¨
  await browser.close();
})();
</code></pre>
<p>æ–°å»ºæ ‡ç­¾é¡µ
ä½¿ç”¨browser.newPage()æ–¹æ³•æ–°å»ºæ ‡ç­¾é¡µ.
è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªPromise,åŒ…å«ä¸€ä¸ªPageå¯¹è±¡ä½œä¸ºå‚æ•°.</p>
<p>ä¾‹å­:</p>
<p>const puppeteer = require('puppeteer');
(async () =&gt; {
const browser = await puppeteer.launch({
headless: false
});
const page = await browser.newPage();
})();
è·å–æ‰€æœ‰æ ‡ç­¾é¡µ
ä½¿ç”¨browser.pages()æ–¹æ³•è·å–æ‰€æœ‰å¯è§çš„æ ‡ç­¾é¡µ.
è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡,åŒ…å«ä¸€ä¸ªArrayä½œä¸ºå‚æ•°.</p>
<p>ä¾‹å­:</p>
<p>const puppeteer = require('puppeteer');
(async () =&gt; {
const browser = await puppeteer.launch({
headless: false
});
console.log(await browser.pages());
})();
è·å–æµè§ˆå™¨é»˜è®¤çš„user-agent
ä½¿ç”¨browser.pages()æ–¹æ³•è·å–æ‰€æœ‰å¯è§çš„æ ‡ç­¾é¡µ.
è¿”å›: Promise(string)</p>
<p>const puppeteer = require('puppeteer');
(async () =&gt; {
const browser = await puppeteer.launch({
headless: false
});
console.log(await browser.userAgent());
})();
Pageå¯¹è±¡
Pageå¯¹è±¡è¡¨ç¤ºä¸€ä¸ªæ ‡ç­¾é¡µ</p>
<p>è®¿é—®ç½‘ç«™
ä½¿ç”¨page.goto(url[, options])æ–¹æ³•è®¿é—®æŒ‡å®šçš„url.
è¿”å›: Promise(Response)</p>
<p>å¸¸ç”¨çš„options:</p>
<p>timeout è¶…æ—¶æ—¶é—´
watiUntil ä½•æ—¶å®Œæˆé¡µé¢åŠ è½½
load è§¦å‘loadäº‹ä»¶(é»˜è®¤)
domcontentloaded è§¦å‘DOMContentLoadedäº‹ä»¶
referer Request headerså¤´çš„refererå‚æ•°, ä¼˜å…ˆçº§é«˜äºpage.setExtraHTTPHeaders()
ä¾‹å­:</p>
<p>const puppeteer = require('puppeteer');
(async () =&gt; {
const browser = await puppeteer.launch({
headless: false,
args: [
// è‡ªåŠ¨æ‰“å¼€è°ƒè¯•å·¥å…·
'--auto-open-devtools-for-tabs'
]
});
const page = await browser.newPage();
// æš‚åœä¸€ä¼š
await page.waitFor(1000);
await page.goto('https://www.example.com', {
waitUntil: 'domcontentloaded',
referer: 'https://www.test.com'
});
})();
è·å–Cookies
ä½¿ç”¨page.cookies([url])è·å–é¡µé¢çš„cookies. è¯¥æ–¹æ³•è¿”å›: Promise(Array)</p>
<p>const puppeteer = require('puppeteer');
(async () =&gt; {
const browser = await puppeteer.launch({
headless: false
});
const page = await browser.newPage();
await page.goto('https://www.baidu.com');
console.log(await page.cookies());
})();
page.cookiesè¿”å›çš„cookieså¦‚ä¸‹.å…¶ä¸­çš„nameä¸ºcookieå, valueä¸ºcookieå€¼:
æ•è·.PNG</p>
<p>å¯ä»¥ç”¨å¦‚ä¸‹æ–¹æ³•å°†å…¶è½¬æ¢ä¸ºstringæ ¼å¼:</p>
<p>const cookiesStr = cookies.map(cookie =&gt; <code>${cookie.name}=${cookie.value}</code>).join(&quot;;&quot;);
è®¾ç½®Cookies
1 è®¾ç½®å•ä¸ªcookieså€¼
ä½¿ç”¨page.setCookie(...cookies)è®¾ç½®cookieså€¼.
è¿”å›: Promise(undefined)</p>
<p>ä¾‹å­:</p>
<p>const puppeteer = require('puppeteer');
(async () =&gt; {
const browser = await puppeteer.launch();
const page = await browser.newPage();
await page.goto('https://www.example.com');
await page.setCookie({
name: 'foo',
value: 'bar'
}, {
name: 'foo1',
value: 'bar2'
});
// or
await page.setCookie.apply(page, [{
name: 'foo2',
value: 'bar2'
}]);
console.log(await page.cookies());
})();
å®˜æ–¹æ–‡æ¡£ setCookie</p>
<p>æ³¨æ„,chromeæµè§ˆå™¨åœ°å€æ ä¸­çš„&quot;æŸ¥çœ‹Cookie&quot;å¾ˆä¸é è°±.ä¿®æ”¹/åˆ é™¤cookieå,æ˜¾ç¤ºçš„å¯èƒ½è¿˜æ˜¯åŸæ¥çš„cookie.
æ¨èä½¿ç”¨document.cookieæ–¹æ³•æ¥æŸ¥çœ‹cookieæœ‰æ²¡æœ‰æ›´æ–°.</p>
<p>const puppeteer = require('puppeteer');
(async () =&gt; {
const browser = await puppeteer.launch({
headless: false,
devtools: true
});
const page = await browser.newPage();
await page.goto('https://www.baidu.com');
await page.waitFor(2000);
await page.setCookie({
name: 'BIDUPSID',
value: '123',
domain: '.baidu.com',
path: '/',
httpOnly: false,
secure: false,
session: false
});
// åœ¨æ ‡ç­¾é¡µç¯å¢ƒ(ä¸Šä¸‹æ–‡)ä¸­æ‰§è¡Œå‘½ä»¤
page.evaluate(() =&gt; console.log(document.cookie));
})();
åˆ é™¤cookie
page.deleteCookie(...cookies)
è¿”å›: Promise(undefined)</p>
<p>const puppeteer = require('puppeteer');
(async () =&gt; {
const browser = await puppeteer.launch({
headless: false,
devtools: true
});
const page = await browser.newPage();
await page.goto('https://www.baidu.com');
await page.deleteCookie({
name: 'BAIDUID',
domain: '.baidu.com',
});
page.evaluate(() =&gt; console.log(document.cookie));
})();
è·å–Dom
ä½¿ç”¨page.$(selector)è·å–å•ä¸ªçš„Domå…ƒç´ , ç›¸å½“äºdocument.querySelector
è¿”å›: Promise(ElementHandle || null)</p>
<p>ä½¿ç”¨page.$$(selector)è·å–å¤šä¸ªçš„Domå…ƒç´ , ç›¸å½“äºdocument.querySelectorAll
è¿”å›: Promise(Array(ElementHandle))</p>
<p>ElementHandleæ˜¯ä¸€ä¸ªObjectå¯¹è±¡,è€ŒéDOMå…ƒç´ .å…¶å‚¨å­˜äº†å¯¹åº”DOMå…ƒç´ çš„ä¿¡æ¯.</p>
<p>è·å–Domå…ƒç´ çš„æ–‡æœ¬å†…å®¹
æ–¹æ³•1:</p>
<p>const bodyElHandle = await page.$('body');
const text = await page.evaluate(bodyEl =&gt; bodyEl.innerText, bodyElHandle);
// or
const text = await page.evaluate(bodyEl =&gt; bodyEl.textContent, bodyElHandle);
æ–¹æ³•2:</p>
<p>const bodyElHandle = await page.$('body');
// getPropertyè¿”å›JSHandleå¯¹è±¡,è€Œéå±æ€§å€¼<br>
const prop = await bodyElHandle.getProperty('innerText');
const text = await (prop.jsonValue());
æ–¹æ³•3:</p>
<p>const text = await page.$eval('body', el =&gt; el.innerText);
å‚è€ƒ</p>
<p>è·å–å¤šä¸ªå…ƒç´ çš„æ–‡æœ¬å†…å®¹:</p>
<p>const text = await page.$$eval('div', (els) =&gt; els.map(el =&gt; el.innerText));
å‚è€ƒ</p>
<p>æˆ–:</p>
<p>const elHandles = await page.$$('div');
const text = await page.evaluate((...els)=&gt; els.map(el =&gt; el.innerText) , ...elHandles);
æ³¨æ„, ä¸å¯ä»¥ç›´æ¥æŠŠpage.$$()æ–¹æ³•è¿”å›çš„Arrayç›´æ¥ä½œä¸ºå‚æ•°ä¼ é€’ç»™page.evaluate,ä¼šæŠ¥é”™.</p>
<p>const elHandles = await page.$$('div');
const text = await page.evaluate((els) =&gt; els.map(el =&gt; el.innerText), elHandles);
// TypeError: Converting circular structure to JSON Are you passing a nested JSHandle?
è¿™æ˜¯å› ä¸º puppeteer çš„å¾ˆå¤šæ–¹æ³•éƒ½ä¸æ”¯æŒä¼ å…¥&quot;åŒ…å«æˆ–åµŒå¥—JSHandle/ElementHandleçš„å¯¹è±¡&quot;ä½œä¸ºå‚æ•°, ä¾‹å¦‚page.evaluate page.$evalç­‰</p>
<p>// æ•°ç»„elsçš„ç»“æ„ä¸º [ElementHandle, ElementHandle]<br>
const elHandles = await page.$$('div');
const text = await page.$eval('body', (body, els) =&gt; body.innerText, elHandles);
// TypeError: Converting circular structure to JSON Are you passing a nested JSHandle?
å¦å¤–,ä¸å¯ä»¥ç›´æ¥è¿”å›DOMå¯¹è±¡æœ¬èº«</p>
<p>const el = await page.$eval('body', el =&gt; el);
console.log(el); // {}
è¿™æ˜¯å› ä¸ºDOMå¯¹è±¡ä¸èƒ½è¢«è½¬åŒ–æˆJSON</p>
<p>JSON.stringify(document.body); //  {}
å‚è€ƒ</p>
<p>è·å–å±æ€§å€¼
åŒä¸Š</p>
<p>Pageäº‹ä»¶
ç±»ä¼¼DOMçš„addEventListener,pageå¯¹è±¡ä¹Ÿæ”¯æŒå“åº”å¤šç§äº‹ä»¶.
å¯ä»¥ç”¨page.on(äº‹ä»¶å, å›è°ƒå‡½æ•°)æ–¹æ³•æ¥å‘é¡µé¢æ·»åŠ äº‹ä»¶.</p>
<p>æ‹¦æˆªrequestè¯·æ±‚
å¯ç”¨page.on('request', callback)æ–¹æ³•æ¥æ‹¦æˆªrequestè¯·æ±‚</p>
<p>æ³¨æ„,å¿…é¡»å¯ç”¨&quot;è¯·æ±‚æ‹¦æˆªå™¨&quot;,æ‰èƒ½ä½¿request.abort, request.continue å’Œ request.respond æ–¹æ³•ç”Ÿæ•ˆ.
å¦åˆ™ä¼šæŠ¥é”™: Request Interception is not enabled!</p>
<p>// å¼€å¯è¯·æ±‚æ‹¦æˆªå™¨,è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªPromise
await page.setRequestInterception(true);
ä¾‹å­:</p>
<p>const puppeteer = require('puppeteer');
(async () =&gt; {
const browser = await puppeteer.launch({
headless: false,
devtools: true
});
const page = await browser.newPage();</p>
<p>const url = 'https://www.baidu.com/';
// å¼€å¯è¯·æ±‚æ‹¦æˆª
await page.setRequestInterception(true);
// è®¾ç½®requestäº‹ä»¶åŠå›è°ƒå‡½æ•°
page.on('request', async (request) =&gt; {
// é™¤äº† https://www.baidu.com/ ä¹‹å¤–, ä¸åŠ è½½åˆ«çš„url<br>
if (request.url() === url) {
request.continue();
return;
}
request.abort();
});
await page.waitFor(500)
await page.goto(url)
})();
æ³¨æ„ä¸Šé¢ä»£ç request.continue()åçš„return.
å¦‚æœå¯¹requesté‡å¤è°ƒç”¨ä¸åŒçš„handle,åˆ™ä¼šè§¦å‘é”™è¯¯: Request is already handled!
ä¾‹å¦‚:</p>
<p>if (request.url() === url) {
request.continue();
}
// è°ƒç”¨continueåæ²¡æœ‰é€€å‡º,åˆè°ƒç”¨äº†abort
request.abort();
æ‹¦æˆªå›¾ç‰‡åŠ è½½
åœ¨requestäº‹ä»¶ä¸­,å¯ç”¨request.resourceType()æ–¹æ³•è·å–requestè¯·æ±‚çš„æ–‡ä»¶ç±»å‹,ä»è€Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªè¯¥è¯·æ±‚.
è¯¥æ–¹æ³•è¿”å›String, å¯èƒ½è¿”å›çš„å€¼æœ‰: documentï¼Œstylesheetï¼Œimageï¼Œmediaï¼Œfontï¼Œscriptï¼Œtexttrackï¼Œxhrï¼Œfetchï¼Œeventsourceï¼Œwebsocketï¼Œmanifestï¼Œother.</p>
<p>ä¾‹å­, ä¸åŠ è½½å›¾ç‰‡:</p>
<p>const puppeteer = require('puppeteer');
(async () =&gt; {
const browser = await puppeteer.launch({
headless: false,
devtools: true
});
const page = await browser.newPage();</p>
<p>const url = 'https://www.baidu.com/';
// å¼€å¯è¯·æ±‚æ‹¦æˆª
await page.setRequestInterception(true);
page.on('request', async (request) =&gt; {
// å¦‚æœæ–‡ä»¶ç±»å‹ä¸ºimage,åˆ™ä¸­æ–­åŠ è½½
if (request.resourceType() === 'image') {
request.abort();
return;
}
// æ­£å¸¸åŠ è½½å…¶ä»–ç±»å‹çš„æ–‡ä»¶
request.continue();
});
await page.waitFor(1000)
await page.goto(url)
})();
ä¹Ÿå¯ä»¥æ‹¦æˆªurlè¯·æ±‚, ç„¶åè¿”å›åˆ«çš„å›¾ç‰‡:</p>
<p>const fs = require('fs-extra');
const puppeteer = require('puppeteer');
// è½½å…¥å›¾åƒ, readFileSyncæ˜¯ä¸€ä¸ªåŒæ­¥å‡½æ•°,å…¶ä½œç”¨æ˜¯è·å–æŒ‡å®šçš„æ–‡ä»¶,è¿”å›ä¸€ä¸ªBufferå¯¹è±¡
const <strong>IMAGE</strong> = fs.readFileSync('./img/success.jpg');
(async () =&gt; {
const browser = await puppeteer.launch({
headless: false,
devtools: true
});
const page = await browser.newPage();</p>
<p>const url = 'https://www.baidu.com/';
await page.setRequestInterception(true);
page.on('request', async (request) =&gt; {
// æ‹¦æˆªå›¾åƒèµ„æºçš„è¯·æ±‚
if (request.resourceType() === 'image') {
// è¿”å›æ›¿æ¢çš„å›¾åƒ
request.respond({
// httpçŠ¶æ€ç 
state: 200,
// è¿”å›çš„æ–‡ä»¶ç±»å‹
contentType: 'image/jpeg',
// è¿”å›æ–‡ä»¶çš„å…·ä½“å†…å®¹, æ¥å—Stringæˆ–Bufferä½œä¸ºå‚æ•°
body: <strong>IMAGE</strong>
})
return;
}
//ä¸å¤„ç†å…¶ä»–èµ„æºçš„è¯·ç”¨
request.continue();
});
await page.waitFor(1000)
await page.goto(url)
})();
æ–‡æ¡£ request.respond</p>
<p>æ³¨æ„: request.respondæ–¹æ³•ä¸æ”¯æŒè¿”å›dataURLç±»å‹çš„æ•°æ®.</p>
<p>å…¶ä»–
ä¸‹è½½å›¾åƒ
puppeteeræ²¡æœ‰ç›´æ¥æä¾›ä¸€ä¸ªAPIæ¥å¯¼å‡ºå›¾åƒ,éœ€è¦ç”¨åˆ«çš„æ–¹æ³•ä¸‹è½½å›¾ç‰‡.</p>
<p>æ–¹æ³•1,ç”¨axiosä¸‹è½½å›¾åƒ:</p>
<p>const fs = require('fs-extra');
const puppeteer = require('puppeteer');
const axios = require('axios');</p>
<p>const dwImage = async (url, headers) =&gt; {
// ä¸‹è½½å›¾ç‰‡
const response = await axios.get(url, {
headers,
responseType: 'arraybuffer'
});
// å‚¨å­˜å›¾ç‰‡
fs.writeFileSync('./logo.png', response.data);
};</p>
<p>(async () =&gt; {
const browser = await puppeteer.launch({
headless: true,
devtools: true,
args: [
'--proxy-server=&quot;direct://&quot;',
'--proxy-bypass-list=*'
]
});
const url = 'https://www.baidu.com/';
const page = await browser.newPage();
await page.goto(url);
// è·å–logoçš„srcåœ°å€
const imageUrl = await page.$eval('#lg img', (imgEl) =&gt; imgEl.src);
dwImage(imageUrl, {
referer: url,
'user-agent': await browser.userAgent()
});
browser.close();
})();
æ–¹æ³•2,ä½¿ç”¨canvaså¯¼å‡ºdataURL:</p>
<p>const fs = require('fs-extra');
const puppeteer = require('puppeteer');</p>
<p>// get dataURL from image element
const getDataURLFromImg = async (imgEl) =&gt; {
console.log(imgEl);
const canvas = document.createElement('canvas');
// naturalWidthè¿”å›å›¾åƒçš„åŸå§‹å°ºå¯¸
canvas.width = imgEl.naturalWidth;
canvas.height = imgEl.naturalHeight;</p>
<p>const ctx = canvas.getContext('2d');
ctx.drawImage(imgEl, 0, 0);
return canvas.toDataURL('image/jpeg', 1);
}</p>
<p>// dataURL to Buffer
const parseDataURL = (dataURL) =&gt; {
const matches = dataURL.match(/^data:(.+);base64,(.+)$/);
if (matches.length !== 3) {
throw new Error('Could not parse data URL.');
}
return {
mime: matches[1],
buffer: Buffer.from(matches[2], 'base64')
};
};</p>
<p>const dwImage = async (elementHandle, page, path) =&gt; {
const dataURL = await page.evaluate(getDataURLFromImg, elementHandle)
const {
buffer
} = parseDataURL(dataURL);
fs.writeFileSync(path, buffer, 'base64');
};</p>
<p>(async () =&gt; {
const browser = await puppeteer.launch({
headless: true,
devtools: true,
args: [
'--proxy-server=&quot;direct://&quot;',
'--proxy-bypass-list=*',
// imgæ ‡ç­¾å¯ä»¥è·¨åŸŸ,ä½†æ˜¯canvasä¸è¡Œ.
//å…³é—­è·¨åŸŸé™åˆ¶
'-â€“disable-web-security',
]
});
const url = 'https://www.baidu.com/';
const page = await browser.newPage();
await page.goto(url);
// è·å–logoçš„srcåœ°å€
const imgElHandle = await page.$('#lg img');
await dwImage(imgElHandle, page, './logo.jpg');
browser.close();
})();
å‚è€ƒ</p>
<p>æ–¹æ³•2çš„ä¸€äº›æ³¨æ„äº‹é¡¹:
1 canvasä¸æ”¯æŒè·¨åŸŸ
è™½ç„¶å¯ä»¥ç”¨drawImageåŠ è½½è·¨åŸŸçš„å›¾åƒ, ä½†ç”¨toDataURLå¯¼å‡ºdataURLæ—¶ä¼šæŠ¥é”™: Tainted canvases may not be exported. éœ€è¦åœ¨å¯åŠ¨browseræ—¶å…è®¸è·¨åŸŸ</p>
<p>const browser = await puppeteer.launch({
args: [
'-â€“disable-web-security',
]
}
å¦‚æœæœåŠ¡å™¨ç«¯å…è®¸,ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®imgçš„crossoriginå±æ€§æ¥æ”¯æŒè·¨åŸŸ.</p>
<p>imgEl.setAttribute('crossorigin', 'Anonymous');
MDN CORS settings attributes</p>
<p>2 toDataURLå¯¼å‡ºå›¾åƒçš„é»˜è®¤æ ¼å¼ä¸ºpng
è°ƒç”¨toDataURLæ—¶,å¦‚æœä¸ä¼ å…¥ç¬¬ä¸€ä¸ªå‚æ•°,åˆ™é»˜è®¤å¯¼å‡ºæ ¼å¼ä¸º&quot;image/png&quot;,è¿™å¯èƒ½ä¼šå¯¼è‡´å›¾ç‰‡å˜å¤§. å¦‚æœä¸éœ€è¦å¯¼å‡ºpng,åˆ™å¯ä»¥è®¾ç½®ä¸ºjpg/webp</p>
<p>canvas.toDataURL('image/jpeg', 1);
MDN toDataUR</p>
<p>3 è·å–å›¾åƒçš„åŸå§‹å¤§å°
img.width/heightè·å–åˆ°çš„æ˜¯imgæ ‡ç­¾çš„å¤§å°,å¯ç”¨HTML5æ–°å¢çš„naturalWidthå’ŒnaturalHeightè·å–imgå›¾åƒçš„åŸå§‹å¤§å°.</p>
<p>canvas.width = imgEl.naturalWidth;
canvas.height = imgEl.naturalHeight;
Chrome å¯åŠ¨å‚æ•°
å‚æ•°	ç”¨é€”
--disable-web-security	å…è®¸è·¨åŸŸ
--proxy-server=127.0.0.1:1080	ä»£ç†
--proxy-bypass-list=*	ä¸èµ°ä»£ç†çš„é“¾æ¥
--disable-gpu	ç¦ç”¨GUP
--ignore-certificate-errors	å¿½ç•¥è¯ä¹¦é”™è¯¯
--auto-open-devtools-for-tabs	è‡ªåŠ¨æ‰“å¼€è°ƒè¯•å·¥å…·
æ›´å¤šé…ç½®å‚æ•°è¯¦è§£ List of Chromium Command Line Switches Â« Peter Beverloo</p>
<p>error
UnhandledPromiseRejectionWarning: TimeoutError: Navigation Timeout Exceeded: 30000ms exceeded
headlesså‚æ•°ä¸ºtrueæ—¶å¯èƒ½ä¼šè§¦å‘è¯¥bug</p>
<p>ä¾‹å¦‚:</p>
<p>puppeteer.launch({headless: true})
// or headlessçš„é»˜è®¤å€¼å°±æ˜¯true
puppeteer.launch()
è§£å†³åŠæ³•,å¦‚æœæ“ä½œç³»ç»Ÿæ˜¯windows7, åˆ™ä½¿ç”¨å¦‚ä¸‹å‚æ•°åˆ›å»º browser:</p>
<p>const browser = await puppeteer.launch({
headless: true,
args: [
// ä¸ä½¿ç”¨ä»»ä½•ä»£ç†
'--proxy-server=&quot;direct://&quot;',
'--proxy-bypass-list=*'
]
});</p>
 </p>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-12 animate-box">
                          
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-12 animate-box">
                          
                              
                                  <div id="gitalk-container"></div>
                              

                              
                          
                      </div>
                  </div>
              </div>

          </article>
      </div>
  </div>

    
<footer id="fh5co-footer">
  <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">å´å…ˆç”Ÿã€‚</a></p>
</footer>


    
<!-- jQuery -->
<script src="https://ershaoyelxw.github.io/gridea.github.io/media/scripts/_vendors/jquery.min.js"></script>
<!-- jQuery Easing -->
<script src="https://ershaoyelxw.github.io/gridea.github.io/media/scripts/_vendors/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://ershaoyelxw.github.io/gridea.github.io/media/scripts/_vendors/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://ershaoyelxw.github.io/gridea.github.io/media/scripts/_vendors/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://ershaoyelxw.github.io/gridea.github.io/media/scripts/_vendors/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://ershaoyelxw.github.io/gridea.github.io/media/scripts/_vendors/md5.min.js"></script>

<script type="application/javascript">
    hljs.initHighlightingOnLoad();
</script>



    
        <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
        <script>

            var gitalk = new Gitalk({
                clientID: '',
                clientSecret: '',
                repo: '',
                owner: '',
                admin: [''],
                id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                distractionFreeMode: false  // Facebook-like distraction free mode
            })

            gitalk.render('gitalk-container')

        </script>
    

    




  </body>
</html>
